# Issue #42 召回编排层任务拆分与排期

## 阶段概览
1. 技术设计评审
2. 召回 Agent 实现
3. 召回源适配器实现
4. 主 Agent 集成与配置接入
5. 监控与实验支持
6. 测试与验收
7. 上线与回顾

## 任务拆分

### 技术设计评审
- **文档准备（AR）**：完善接口契约、子图流程图、配置与监控方案。
- **评审会议（AR/PM/LD/平台团队）**：评审疑问记录、确认边界与责任。
- **设计修订（AR）**：根据评审反馈更新设计、ADR。

### 召回 Agent 实现（Iteration 1）
- **接口与数据模型（LD-A）**：实现 `RecallRequest` / `RecallResult` dataclass；编写序列化与校验工具。
- **LangGraph 子图结构（LD-A）**：实现 `graph.py` 与 `nodes.py` 框架，包含 `prepare` → `fanout` → `merge` → `fallback` → `output`。
- **排序与去重策略（LD-A）**：实现权重排序、去重、降级逻辑；可配置化权重、阈值。
- **配置加载（LD-A）**：扩展 `settings` 及模块内配置加载，支持默认配置与后续热更新。

### 召回源适配器（Iteration 1-2）
- **向量源适配（LD-B）**：封装 Milvus 检索为 `RecallSource` 实现。
- **关键词/规则源（LD-B）**：实现关键词或规则匹配，支持配置。
- **FAQ 源（LD-B）**：将 FAQ 数据访问封装为召回源。
- **业务 API 源（可选迭代）**：预留接口或占位实现。
- **并行调用与熔断（LD-B）**：实现异步并行调度、超时、重试及熔断策略。

### 主 Agent 集成与配置（Iteration 2）
- **主图调用改造（LD-C）**：修改 `retrieve_node`，通过召回 Agent 获取结果并处理异常。
- **结果兼容（LD-C）**：确保 `RecallResult` 转换为生成层所需格式，更新测试。
- **配置透传（LD-C/PM）**：确认运营可配置的字段与默认值；准备 `.env.example` 说明。

### 监控与实验支持（Iteration 2-3）
- **日志与指标（LD-D/平台团队）**：添加 trace/experiment 透传、召回耗时与成功率指标；接入告警。
- **实验 ID 支持（LD-D）**：在召回 Agent 和主 Agent 中支持实验配置切换与埋点。
- **配置中心/实验平台对接（可选）**：预留接口或 PoC。

### 测试与验收（Iteration 3）
- **单元测试（LD-A/B）**：召回源、排序、降级、配置加载。
- **集成测试（LD-C）**：主 Agent ↔ 召回 Agent 链路、熔断、灰度开关。
- **性能测试（QA/平台团队）**：并行召回延迟与成功率验证。
- **验收回合（PM/AR）**：核对功能/质量/业务验收标准。

### 上线与回顾
- **灰度计划（PM/运维）**：制定灰度发布、回滚策略。
- **上线监控（平台团队）**：上线后持续监控指标与告警。
- **回顾总结（全员）**：上线一段时间后复盘效果、记录改进点。

## 排期建议
| 迭代 | 时间 | 关键任务 |
| --- | --- | --- |
| Iteration 0 | 1 周 | 技术设计评审 + 修订 |
| Iteration 1 | 2 周 | 召回 Agent 子图、核心接口、基础召回源（向量/关键词/FAQ） |
| Iteration 2 | 2 周 | 主 Agent 集成、配置透传、监控与实验支持 |
| Iteration 3 | 1-2 周 | 测试、性能验证、灰度上线 |

> 时间可根据团队能力与优先级调整。

## 分工建议
- **AR**：设计文档维护、技术评审、架构把关。
- **LD-A**：召回 Agent 子图与核心逻辑。
- **LD-B**：召回源适配器与并行/熔断实现。
- **LD-C**：主 Agent 集成、配置透传。
- **LD-D / 平台团队**：监控埋点、实验/配置中心接入。
- **PM/运营**：配置策略、实验方案、验收。

---
*更新时间：2025-10-18*

### 附：命名与目录调整决定
- 配置重命名：Iteration 0 即刻执行，将 `rag_*` 字段迁移为 `vector_*`，并保留别名兼容；
- 主对话 Agent 目录重构：计划在召回模块发布后另行执行（参见 Issue #43）。
