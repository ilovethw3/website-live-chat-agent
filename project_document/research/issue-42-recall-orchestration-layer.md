# Issue #42 召回编排层架构评审

## Analysis

### 现有架构上下文
- **核心工作流**：LangGraph Agent（ADR-0001）负责路由→检索→生成，目前检索节点仅调用向量检索（Milvus）。
- **知识库结构**：知识文档与 FAQ 同存于知识库，但缺少统一的召回协调层。
- **监控现状**：向量调用日志存在，但缺乏跨召回源的统一指标与告警。
- **配置方式**：召回逻辑写死在 `src/agent/nodes.py` 与 `src/agent/tools.py`。

### 架构影响域
- **受影响组件**
  - `src/agent/nodes.py` / `src/agent/tools.py`：检索节点需要改造为调用独立的召回 Agent；
  - 新增召回编排 Agent（建议位于 `src/agents/recall` 或独立 LangGraph 子图/服务层模块）；
  - 召回源适配器与配置管理（复用 `src/core/config.py`，并预留外部配置中心接口）；
  - 召回监控/日志链路（`src/core/logging`、metrics 与告警接入）。
- **不受影响组件**
  - 主对话 Agent 的对话状态与生成节点 (`call_llm_node`)；
  - API 层入口（召回改造后对外接口保持不变）；
  - 底层知识存储（Milvus/FAQ 数据结构维持原状）。

### 与现有 ADR 一致性检查
- **ADR-0001 LangGraph 架构**：新增编排层不改变 LangGraph 状态机，只是将检索节点的调用改为多源聚合 → **一致**。
- 现有 ADR 未覆盖召回编排，需要新增 ADR 记录决策。

### 风险识别矩阵
| 风险类别 | 描述 | 级别 | 缓解措施 |
| --- | --- | --- | --- |
| 技术 | 并行调用多召回源导致延迟增加 | 🟡 中 | 设置超时/熔断、并发调用、缓存热点 | 
| 技术 | 配置不当导致召回结果异常（空/重复） | 🟡 中 | 引入配置校验、预设默认权重、蓝绿/灰度流程 |
| 技术 | 日志与指标增多导致存储压力 | 🟢 低 | 统一日志格式，设置保留策略 |
| 业务 | 召回结果权重调整失败影响命中率 | 🟡 中 | 提供回滚配置、上线前实验验证 |
| 业务 | 运营误操作导致关键召回源关闭 | 🟡 中 | 配置权限和审批流程、操作日志 |
| 合规 | FAQ/自定义召回结果可能引入不符合政策的内容 | 🟢 低 | 与现有内容审计流程衔接，不新增外部数据源 |
| 安全 | 新 API 暴露导致未授权调用 | 🟢 低 | 接入统一鉴权/内网调用 |

### 技术约束分析
- **P0 必须遵守**
  - 召回编排层必须无状态，可水平扩展；
  - 与生成层之间使用清晰的接口契约（协议/Schema）；
  - 必须提供熔断和超时机制，避免单个召回源拖垮整体；
  - 输出结果需包含来源、置信度、命中原因，满足追踪；
  - 所有配置变更必须可回滚、可追踪。
- **P1 强烈建议**
  - 采用异步并行调用、优先使用现有事件循环；
  - 引入统一日志字段（trace_id、experiment_id）；
  - 引入基础缓存（FAQ 或高频匹配）。
- **P2 可选**
  - 提供可插拔 rerank 插槽；
  - 对接外部实验平台（GrowthBook 等）；
  - 结果数据写入数据仓库用于长期分析。

### 代码热点与接口
- **召回编排 Agent**：新建 LangGraph 子图/Agent，例如 `src/agents/recall/graph.py`，包含召回源节点、排序节点、降级节点；
- **召回源适配器**：向量（`src/services/milvus_service.py`）、关键词/规则、FAQ、业务 API 等模块需抽象出 `RecallSource` 接口；
- **配置加载**：`src/core/config.py` 扩展召回配置项，预留实验/配置中心接口；
- **主 Agent 集成**：`src/agent/nodes.py` 的 `retrieve_node` 改为调用召回 Agent（通过函数、内部 RPC 或 `invoke_sub_agent`）；
- **监控/日志**：`src/core/logging`、`src/core/metrics.py`（若无需新建则在此扩展），统一 trace_id 与实验 ID。

## Proposed Solutions

| 维度 | 方案A：独立微服务 | 方案B：Agent 内嵌模块 | 方案C：服务层模块化 | 方案D：多 Agent 架构（推荐） |
| --- | --- | --- | --- | --- |
| 技术复杂度 | 🔴 高 | 🟢 低 | 🟡 中 | 🟡 中 |
| 运维成本 | 🔴 高 | 🟢 低 | 🟡 中 | 🟡 中 |
| 可扩展性 | 🟢 高 | 🟡 中 | 🟢 高 | 🟢 高 |
| 实验/配置能力 | 🟢 高 | 🟡 中 | 🟡 中 | 🟢 高 |
| 与主 Agent 解耦 | 🟢 高 | 🔴 低 | 🟡 中 | 🟢 高 |
| 部署灵活性 | 🟢 高 | 🟡 中 | 🟢 高 | 🟢 高（可同进程或独立部署） |
| MVP 适用性 | ❌ | ✅ | ✅ | ✅ |

### 方案说明
- **方案A：独立微服务**
  - 优势：完全解耦，可独立部署扩缩容，方便接入多客户端。
  - 劣势：新增服务治理负担，需要独立身份鉴权、监控，开发周期长。
  - 风险：短期内运营需要的配置入口尚未准备，可能投入过大。
- **方案B：Agent 内嵌模块**
  - 优势：修改最小，复用现有进程和配置；
  - 劣势：与 Agent 强耦合，未来扩展或多渠道复用困难；
  - 风险：难以做 A/B 实验和独立监控；发生异常会直接影响 Agent 可用性。
- **方案C：服务层模块化**
  - 在当前服务层实现 orchestrator 模块，供主 Agent 调用；保持接口清晰，为后续升级做准备。
  - 适合作为过渡方案，但对多产品复用能力有限。
- **方案D：多 Agent 架构（推荐）**
  - 做法：构建独立的召回编排 Agent（LangGraph 子图或独立 Agent 应用），主对话 Agent 通过 `invoke_sub_agent` 或 RPC 调用。
  - 优势：职责清晰、易于独立扩缩容，可逐步演进为独立服务；保留 LangGraph 带来的可视化和状态管理优势。
  - 风险：需要设计跨 Agent 的接口、权限与 Trace 传递；需额外处理调用延迟。

### 架构师推荐
- **推荐方案D（多 Agent 架构）—— 有条件推荐**
  - 先在同一进程内实现召回 Agent（子图），保持无状态接口和清晰契约；
  - 召回 Agent 内部使用服务层模块化架构（方案C）实现召回源调度与配置；未来可平滑迁移到独立服务（方案A）。
  - 条件：需要统一 `RecallRequest/Result` schema、trace/experiment 透传，并规划好监控与熔断策略。

## Implementation Plan

### 变更范围
- 新增召回编排 Agent（LangGraph 子图）：`src/agents/recall/graph.py`、`states.py`、`nodes` 等；
- 召回源适配模块：向量、关键词、FAQ、业务 API 等统一抽象；
- 主对话 Agent `retrieve_node` 调整为调用召回 Agent（同进程函数调用或 `invoke_sub_agent`）；
- 配置扩展（`src/core/config.py` / `.env.example`）及实验参数；
- 监控与日志：统一 trace_id、召回指标、告警；
- 单元/集成测试与文档更新。

### 实施步骤概览（供 LD 细化）
1. **定义多 Agent 接口契约**
   - 标准化 `RecallRequest` / `RecallResult`，明确上下文、实验 ID、Trace 信息的传递。
   - 约定主 Agent 与召回 Agent 的调用方式（函数调用、LangGraph 子图、RPC）。
2. **实现召回编排 Agent**
   - 在 LangGraph 中构建召回子图：入口节点 → 并行调用各召回源节点 → 汇总节点（排序、去重、降级）→ 输出节点。
   - 召回源适配器模块化，实现统一接口，支持分阶段上线。
   - 配置加载：权重、超时、实验策略，预留配置中心接入。
3. **主 Agent 集成**
   - 修改 `retrieve_node`：通过 `invoke_sub_agent` 或内部调用方式请求召回 Agent，处理结果/异常；
   - 确保返回结构兼容生成节点。
4. **监控与日志**
   - 在主 Agent 与召回 Agent 之间透传 trace_id、experiment_id；
   - 记录召回源耗时、成功率、超时次数，接入告警；
   - 召回 Agent 输出关键指标（召回命中率、降级次数）。
5. **实验与配置支持**
   - 召回 Agent 根据实验配置选择策略，输出实验埋点；
   - 与实验平台/配置中心对接，支持灰度调整。
6. **测试与文档**
   - 单元测试：召回源调用、排序、降级、配置读取；
   - 集成测试：主 Agent ↔ 召回 Agent 调用链、熔断、实验切换；
   - 文档：配置指南、监控指引、实验操作手册。

### 架构约束清单
- **P0**: 编排模块必须可无状态部署；所有外部调用需设置超时+熔断；接口契约需版本化管理。
- **P1**: 并行模式使用异步/线程池；结果排序支持加权可扩展；记录 trace_id。
- **P2**: 支持缓存、rerank 插槽、外部实验平台集成。

### 验收标准对应
- [ ] 功能：支持多召回源、可配置权重、降级机制；对下游输出统一结果。
- [ ] 质量：P99 ≤ 800ms、成功率 ≥ 99%，具备监控告警。
- [ ] 业务：配置上线 ≤ 30 分钟；召回命中率提升目标（需数据验证）。

### 后续工作建议
- 补充 ADR 记录召回编排层的架构决策（建议编号 0007）。
- 规划运营后台（配置入口、实验看板）与数据分析 pipeline。
- 制定灰度与回滚流程文档。
