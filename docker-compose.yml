version: '3.8'

services:
  chat-agent:
    build: .
    container_name: website-live-chat-agent
    ports:
      - "8000:8000"
    environment:
      # LLM 配置
      - LLM_PROVIDER=deepseek
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_BASE_URL=https://api.deepseek.com/v1
      - DEEPSEEK_MODEL=deepseek-chat
      
      # LLM URL 配置（可选）
      # - LLM_BASE_URL_FIELD=${LLM_BASE_URL_FIELD}
      # - OPENAI_LLM_BASE_URL=${OPENAI_LLM_BASE_URL}
      # - DEEPSEEK_LLM_BASE_URL=${DEEPSEEK_LLM_BASE_URL}
      # - SILICONFLOW_LLM_BASE_URL=${SILICONFLOW_LLM_BASE_URL}
      # - ANTHROPIC_LLM_BASE_URL=${ANTHROPIC_LLM_BASE_URL}
      
      # Embedding 配置
      - EMBEDDING_PROVIDER=deepseek
      - EMBEDDING_MODEL=deepseek-embedding
      - EMBEDDING_DIM=1536
      
      # Embedding API Key 配置（可选）
      # - EMBEDDING_API_KEY_FIELD=${EMBEDDING_API_KEY_FIELD}
      # - OPENAI_EMBEDDING_API_KEY=${OPENAI_EMBEDDING_API_KEY}
      # - DEEPSEEK_EMBEDDING_API_KEY=${DEEPSEEK_EMBEDDING_API_KEY}
      # - SILICONFLOW_EMBEDDING_API_KEY=${SILICONFLOW_EMBEDDING_API_KEY}
      # - ANTHROPIC_EMBEDDING_API_KEY=${ANTHROPIC_EMBEDDING_API_KEY}
      
      # Embedding URL 配置（可选）
      # - EMBEDDING_BASE_URL=${EMBEDDING_BASE_URL}
      # - OPENAI_EMBEDDING_BASE_URL=${OPENAI_EMBEDDING_BASE_URL}
      # - DEEPSEEK_EMBEDDING_BASE_URL=${DEEPSEEK_EMBEDDING_BASE_URL}
      # - SILICONFLOW_EMBEDDING_BASE_URL=${SILICONFLOW_EMBEDDING_BASE_URL}
      # - ANTHROPIC_EMBEDDING_BASE_URL=${ANTHROPIC_EMBEDDING_BASE_URL}
      
      # Milvus 配置（已部署）
      - MILVUS_HOST=${MILVUS_HOST:-your-milvus-host}
      - MILVUS_PORT=${MILVUS_PORT:-19530}
      - MILVUS_USER=${MILVUS_USER:-root}
      - MILVUS_PASSWORD=${MILVUS_PASSWORD:-}
      - MILVUS_DATABASE=${MILVUS_DATABASE:-default}
      
      # Redis 配置
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      
      # API 配置
      - API_KEY=${API_KEY:-change-this-key}
      - CORS_ORIGINS=*
      
      # 应用配置
      - LOG_LEVEL=INFO
      - PORT=8000
      
      # LangGraph 配置
      - LANGGRAPH_MAX_ITERATIONS=10
      - LANGGRAPH_CHECKPOINTER=redis
      
      # RAG 配置
      - RAG_TOP_K=3
      - RAG_SCORE_THRESHOLD=0.7
      - RAG_CHUNK_SIZE=500
      - RAG_CHUNK_OVERLAP=50
      
      # 消息过滤配置
      - MESSAGE_FILTER_ENABLED=true
      - MESSAGE_MAX_LENGTH=1000
      - INSTRUCTION_KEYWORDS=You are an AI,Your role is to,Follow these guidelines,Use user's language,Always return,Always wrap,You are a helpful assistant,Your task is to,Please rephrase,Convert the following,Transform this query
      - TECHNICAL_TERMS_THRESHOLD=3
      - TECHNICAL_TERMS=API,endpoint,function,method,parameter,response,request
    
    depends_on:
      - redis
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  redis:
    image: redis:7-alpine
    container_name: chat-agent-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped

volumes:
  redis-data:

